<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>blockframes documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	      <link rel="stylesheet" href="../styles/style.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">blockframes documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content interface">
                   <div class="content-data">












<ol class="breadcrumb">
  <li>Interfaces</li>
  <li>DeliveryContent</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>apps/backend-functions/src/internals/pdf.ts</code>
        </p>

            <p class="comment">
                <h3>Description</h3>
            </p>
            <p class="comment">
                <p>Internal type expected by the pdf generation for delivery.</p>

            </p>


        <section>
            <h3 id="index">Index</h3>
            <table class="table table-sm table-bordered index-table">
                <tbody>
                    <tr>
                        <td class="col-md-4">
                            <h6><b>Properties</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                        <a href="#materials">materials</a>
                                </li>
                                <li>
                                        <a href="#orgs">orgs</a>
                                </li>
                                <li>
                                        <a href="#steps">steps</a>
                                </li>
                                <li>
                                        <a href="#txID">txID</a>
                                </li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>



            <section>
                <h3 id="inputs">Properties</h3>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="materials"></a>
                                        <span class="name"><b>materials</b><a href="#materials"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>materials:         <code><a href="../miscellaneous/typealiases.html#Material" target="_self" >MaterialDocument[]</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="../miscellaneous/typealiases.html#Material" target="_self" >MaterialDocument[]</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="orgs"></a>
                                        <span class="name"><b>orgs</b><a href="#orgs"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>orgs:         <code><a href="../miscellaneous/typealiases.html#IDMap" target="_self" >IDMap&lt;OrganizationDocument&gt;</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="../miscellaneous/typealiases.html#IDMap" target="_self" >IDMap&lt;OrganizationDocument&gt;</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="steps"></a>
                                        <span class="name"><b>steps</b><a href="#steps"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>steps:     <code>IDMap&lt;StepDocumentWithDate&gt;</code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code>IDMap&lt;StepDocumentWithDate&gt;</code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="txID"></a>
                                        <span class="name"><b>txID</b><a href="#txID"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>txID:     <code>literal type</code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code>literal type</code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
            </section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { groupBy, sortBy, isEmpty } from &#x27;lodash&#x27;;
import {
  asIDMap,
  DeliveryDocument,
  IDMap,
  MaterialDocument,
  OrganizationDocument,
  StepDocumentWithDate,
  convertStepDocumentToStepDocumentWithDate,
  StakeholderDocument
} from &#x27;../data/types&#x27;;
import { getCollection, getDocument } from &#x27;../data/internals&#x27;;

const PdfPrinter &#x3D; require(&#x27;pdfmake&#x27;);

// Types
// &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;

/**
 * Internal type expected by the pdf generation for delivery.
 */
interface DeliveryContent {
  txID: { [stakeholderID: string]: string };
  orgs: IDMap&lt;OrganizationDocument&gt;;
  steps: IDMap&lt;StepDocumentWithDate&gt;;
  materials: MaterialDocument[];
}

// Constants for styles &amp; fonts
// &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;
const FONTS &#x3D; {
  Helvetica: {
    normal: &#x27;Helvetica&#x27;,
    bold: &#x27;Helvetica-Bold&#x27;,
    italics: &#x27;Helvetica-Oblique&#x27;,
    bolditalics: &#x27;Helvetica-BoldOblique&#x27;
  }
};

const STYLE_HEADER &#x3D; &#x27;header&#x27;;
const STYLE_SUBHEADER &#x3D; &#x27;subheader&#x27;;
const STYLE_DESCRIPTION &#x3D; &#x27;description&#x27;;
const STYLE_BOLD &#x3D; &#x27;bold&#x27;;
const STYLE_TABLE_MATERIALS &#x3D; &#x27;styleTableMaterials&#x27;;

// Helpers
// -------

const withStyle &#x3D; (text: string, style: string): any &#x3D;&gt; ({
  text,
  style
});

const header &#x3D; (text: string) &#x3D;&gt; withStyle(text, STYLE_HEADER);
const subHeader &#x3D; (text: string) &#x3D;&gt; withStyle(text, STYLE_SUBHEADER);
const description &#x3D; (text: string) &#x3D;&gt; withStyle(text, STYLE_DESCRIPTION);
const bold &#x3D; (text: string) &#x3D;&gt; withStyle(text, STYLE_BOLD);

const center &#x3D; (content: string | { [k: string]: any }): any &#x3D;&gt; {
  if (typeof content &#x3D;&#x3D;&#x3D; typeof &#x27;string&#x27;) {
    return { text: content, alignment: &#x27;center&#x27; };
  } else {
    // @ts-ignore: TODO: debug this switch
    return { ...content, alignment: &#x27;center&#x27; };
  }
};

// PDF Generation
// &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;

// These functions take our blockframes model and generate data the pdf rendering.

/**
 * Render a list of orgs / stakeholders
 *
 * This returns the PDFMake columns:
 * &#x60;&#x60;&#x60;
 * ## Stakeholders
 *
 * | OrgName      | OrgName      | OrgName      | OrgName      |
 * | orgAddress   | orgAddress   | orgAddress   | orgAddress   |
 * &#x60;&#x60;&#x60;
 *
 * The parameter orgIds is used to enforce a certain order.
 *
 * @param orgIds
 * @param orgs
 */
function rowOrganizations(orgIds: string[], orgs: IDMap&lt;OrganizationDocument&gt;): any {
  const columns: any &#x3D; orgIds.map((id: string) &#x3D;&gt; {
    const org &#x3D; orgs[id];
    return [subHeader(org.name), description(org.officeAddress)];
  });
  return [
    header(&#x27;Stakeholders&#x27;),
    {
      alignment: &#x27;center&#x27;,
      columns
    }
  ];
}

/**
 * Render a list of material, assumes they are all in the same category.
 *
 * This returns the PDFMake table:
 * &#x60;&#x60;&#x60;
 *    +---------------------------------------+------+
 *    | material value                        | step |
 *    | Material description                  |      |
 *    +---------------------------------------+------+
 *    | material value                        | step |
 *    | Material description                  |      |
 *    +---------------------------------------+------+
 *    | material value                        | step |
 *    | Material description                  |      |
 *    +---------------------------------------+------+
 * &#x60;&#x60;&#x60;
 *
 * @param materials
 * @param steps
 */
function rowMaterials(
  materials: MaterialDocument[],
  steps: { [id: string]: StepDocumentWithDate }
): any {
  // NOTE: pdfmake side-effect over the data provided, we can reuse the same objects
  // multiple time, we have to keep this variable definition INSIDE the forEach.
  const tableHeader &#x3D; [bold(&#x27;material&#x27;), center(bold(&#x27;step&#x27;))];

  const tableBody &#x3D; materials.map(material &#x3D;&gt; [
    [bold(material.value), description(material.description)],
    center({
      text: material.stepId ? steps[material.stepId].name : &#x27;&#x27;,
      margin: [0, 4, 0, 0]
    })
  ]);

  return {
    style: STYLE_TABLE_MATERIALS,
    table: {
      headerRows: 1,
      widths: [&#x27;80%&#x27;, &#x27;20%&#x27;],
      body: [[...tableHeader], ...tableBody]
    }
  };
}

/**
 * Render a list of materials, grouped by category.
 *
 * This returns the PDFMake list of tables:
 *
 * &#x60;&#x60;&#x60;
 * ## Category1
 *
 *    +---------------------------------------+------+
 *    | material value                        | step |
 *    | Material description                  |      |
 *    +---------------------------------------+------+
 *    | material value                        | step |
 *    | Material description                  |      |
 *    +---------------------------------------+------+
 *    | material value                        | step |
 *    | Material description                  |      |
 *    +---------------------------------------+------+
 *
 * ## Category2
 *
 *    +---------------------------------------+------+
 *    | material value                        | step |
 *    | Material description                  |      |
 *    +---------------------------------------+------+
 * &#x60;&#x60;&#x60;
 *
 * @param materials
 * @param steps
 */
function rowMaterialsPerCategory(
  materials: MaterialDocument[],
  steps: { [id: string]: StepDocumentWithDate }
): any {
  const materialsPerCategory &#x3D; groupBy(
    materials,
    (material: MaterialDocument) &#x3D;&gt; material.category
  );
  const categories &#x3D; sortBy(Object.keys(materialsPerCategory));

  const tables: any[] &#x3D; [];

  categories.forEach(category &#x3D;&gt; {
    tables.push(subHeader(category));
    tables.push(rowMaterials(materialsPerCategory[category], steps));
  });

  return [header(&#x27;Materials&#x27;), ...tables];
}

/**
 * Render a list of orgs&#x27; transactions ids as QR codes
 *
 * This returns the PDFMake columns:
 * &#x60;&#x60;&#x60;
 * ## Signatures
 *
 * | OrgName      | OrgName      | OrgName      | OrgName      |
 * | ▒ tx QR Code | ▒ tx QR Code | ▒ tx QR Code | ▒ tx QR Code |
 * &#x60;&#x60;&#x60;
 *
 * The parameter orgIds is used to enforce a certain order.

 *
 * @param organizationIds
 * @param organizations
 * @param txID
 */
function rowSignatures(
  organizationIds: string[],
  organizations: { [id: string]: OrganizationDocument },
  txID: { [orgId: string]: string }
): any {
  if (isEmpty(txID)) {
    return [];
  }

  const columns &#x3D; organizationIds.map((id: string) &#x3D;&gt; {
    const stakeholder &#x3D; organizations[id];
    const tx &#x3D; txID[id];

    return [bold(stakeholder.name), { qr: tx, fit: &#x27;100&#x27; }];
  });

  return [
    header(&#x27;Signatures&#x27;),
    {
      alignment: &#x27;center&#x27;,
      columns
    }
  ];
}

/**
 * Render a delivery, its stakeholders, transactions and materials into a PDF document.
 *
 * @param txID
 * @param orgs
 * @param materials
 * @param steps
 */
export function buildDeliveryPDF({ txID, orgs, materials, steps }: DeliveryContent) {
  // We store keys first to make sure order is preserved along the way
  const orgsIds &#x3D; Object.keys(orgs);

  const docDefinition &#x3D; {
    content: [
      ...rowOrganizations(orgsIds, orgs),
      ...rowMaterialsPerCategory(materials, steps),
      ...rowSignatures(orgsIds, orgs, txID)
    ],
    defaultStyle: {
      font: &#x27;Helvetica&#x27;
    },
    styles: {
      [STYLE_TABLE_MATERIALS]: {
        margin: [5, 5, 5, 5]
      },
      [STYLE_HEADER]: {
        fontSize: 18,
        bold: true,
        margin: [5, 20, 5, 5]
      },
      [STYLE_SUBHEADER]: {
        fontSize: 14,
        bold: true,
        margin: [5, 10, 5, 5]
      },
      [STYLE_DESCRIPTION]: {
        fontSize: 10,
        italics: true
      },
      [STYLE_BOLD]: {
        bold: true
      }
    }
  };
  const printer &#x3D; new PdfPrinter(FONTS);
  return printer.createPdfKitDocument(docDefinition);
}

/**
 * Handle firebase requests to generate the PDF of a delivery.
 *
 * Wrapper around buildDeliveryPDF,
 * handles firebase request, loads the delivery data from firestore
 * and pipe the PDF to the express response.
 *
 * @param req   express requests, expects &#x60;deliveryId&#x60; in the query parameters.
 * @param resp  express response, we will feed it with the pdf content.
 */
export async function onGenerateDeliveryPDFRequest(req: any, resp: any) {
  const deliveryId: string &#x3D; req.query.deliveryId;

  // TODO: factor out the data layer
  const delivery &#x3D; await getDocument&lt;DeliveryDocument&gt;(&#x60;deliveries/${deliveryId}&#x60;);
  const stakeholders &#x3D; await getCollection&lt;StakeholderDocument&gt;(
    &#x60;deliveries/${deliveryId}/stakeholders&#x60;
  );

  const orgs &#x3D; await Promise.all(
    stakeholders.map(({ id }) &#x3D;&gt; getDocument&lt;OrganizationDocument&gt;(&#x60;orgs/${id}&#x60;))
  );

  const materials &#x3D; await getCollection&lt;MaterialDocument&gt;(&#x60;deliveries/${deliveryId}/materials&#x60;);

  const steps &#x3D; asIDMap(convertStepDocumentToStepDocumentWithDate(delivery.steps));

  const pdf &#x3D; buildDeliveryPDF({ orgs: asIDMap(orgs), materials, steps, txID: {} });
  pdf.pipe(resp);
  pdf.end();
}
</code></pre>
    </div>
</div>


                   




                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> result-matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'interface';
            var COMPODOC_CURRENT_PAGE_URL = 'DeliveryContent.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>
       <!-- Required to polyfill modern browsers as code is ES5 for IE... -->
       <script src="../js/libs/custom-elements-es5-adapter.js" charset="utf-8" defer></script>
       <script src="../js/menu-wc.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
