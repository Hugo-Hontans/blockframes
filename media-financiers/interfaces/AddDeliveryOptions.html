<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>blockframes documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	      <link rel="stylesheet" href="../styles/style.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">blockframes documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content interface">
                   <div class="content-data">












<ol class="breadcrumb">
  <li>Interfaces</li>
  <li>AddDeliveryOptions</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>libs/material/src/lib/delivery/+state/delivery.service.ts</code>
        </p>



        <section>
            <h3 id="index">Index</h3>
            <table class="table table-sm table-bordered index-table">
                <tbody>
                    <tr>
                        <td class="col-md-4">
                            <h6><b>Properties</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#movieId">movieId</a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#mustBeSigned">mustBeSigned</a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#mustChargeMaterials">mustChargeMaterials</a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#templateId">templateId</a>
                                </li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>



            <section>
                <h3 id="inputs">Properties</h3>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="movieId"></a>
                                        <span class="name"><b>movieId</b><a href="#movieId"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>movieId:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="mustBeSigned"></a>
                                        <span class="name"><b>mustBeSigned</b><a href="#mustBeSigned"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>mustBeSigned:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="mustChargeMaterials"></a>
                                        <span class="name"><b>mustChargeMaterials</b><a href="#mustChargeMaterials"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>mustChargeMaterials:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="templateId"></a>
                                        <span class="name"><b>templateId</b><a href="#templateId"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>templateId:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
            </section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Injectable } from &#x27;@angular/core&#x27;;
import { DeliveryQuery } from &#x27;./delivery.query&#x27;;
import { Material } from &#x27;../../material/+state/material.model&#x27;;
import { createDelivery, Delivery, DeliveryWithTimestamps, deliveryStatuses, Step } from &#x27;./delivery.model&#x27;;
import {
  Movie,
  MovieQuery
} from &#x27;@blockframes/movie&#x27;;
import { OrganizationQuery, PermissionsService, StakeholderService, Stakeholder } from &#x27;@blockframes/organization&#x27;;
import { BFDoc, FireQuery } from &#x27;@blockframes/utils&#x27;;
import { MaterialQuery, MaterialService, createMaterial } from &#x27;../../material/+state&#x27;;
import { TemplateQuery } from &#x27;../../template/+state&#x27;;
import { DeliveryOption, DeliveryWizard, DeliveryWizardKind } from &#x27;./delivery.store&#x27;;
import { AngularFirestoreCollection, AngularFirestoreDocument } from &#x27;@angular/fire/firestore&#x27;;
import * as firebase from &#x27;firebase&#x27;;
import { WalletService } from &#x27;libs/ethers/src/lib/wallet/+state&#x27;;
import { CreateTx, TxFeedback } from &#x27;@blockframes/ethers&#x27;;
import { StakeholderDocument, createStakeholder } from &#x27;@blockframes/organization/stakeholder/types&#x27;;

interface AddDeliveryOptions {
  templateId?: string;
  movieId?: string;
  mustChargeMaterials?: boolean;
  mustBeSigned?: boolean;
}

export function timestampObjectsToDate(docs: any[]) {
  if (!docs) {
    return [];
  }

  return docs.map(doc &#x3D;&gt; {
    if (doc.date) {
      return { ...doc, date: doc.date.toDate() };
    } else {
      return doc;
    }
  });
}

/** Takes a DeliveryDB (dates in Timestamp) and returns a Delivery with dates in type Date */
export function modifyTimestampToDate(delivery: DeliveryWithTimestamps): Delivery {
  const mgDeadlines &#x3D; delivery.mgDeadlines || [];

  return {
    ...delivery,
    dueDate: delivery.dueDate ? delivery.dueDate.toDate() : null,
    steps: timestampObjectsToDate(delivery.steps),
    mgDeadlines: timestampObjectsToDate(mgDeadlines)
  };
}

@Injectable({
  providedIn: &#x27;root&#x27;
})
export class DeliveryService {
  constructor(
    private movieQuery: MovieQuery,
    private templateQuery: TemplateQuery,
    private materialQuery: MaterialQuery,
    private materialService: MaterialService,
    private organizationQuery: OrganizationQuery,
    private query: DeliveryQuery,
    private permissionsService: PermissionsService,
    private shService: StakeholderService,
    private walletService: WalletService,
    private db: FireQuery
  ) {}

  ///////////////////////////
  // Document manipulation //
  ///////////////////////////

  private movieDoc(movieId: string): AngularFirestoreDocument&lt;Movie&gt; {
    return this.db.doc&lt;Movie&gt;(&#x60;movies/${movieId}&#x60;);
  }

  private get currentDeliveryDoc() {
    return this.deliveryDoc(this.query.getActiveId());
  }

  private materialDeliveryDoc(deliveryId: string, materialId: string): AngularFirestoreDocument {
    return this.deliveryDoc(deliveryId).collection(&#x27;materials&#x27;).doc(materialId);
  }

  private deliveryDoc(deliveryId: string): AngularFirestoreDocument&lt;DeliveryWithTimestamps&gt; {
    return this.db.doc(&#x60;deliveries/${deliveryId}&#x60;);
  }

  private deliveryStakeholderDoc(
    deliveryId: string,
    stakeholderId: string
  ): AngularFirestoreDocument&lt;StakeholderDocument&gt; {
    return this.deliveryStakeholdersCollection(deliveryId).doc(stakeholderId);
  }

  private deliveryStakeholdersCollection(deliveryId: string): AngularFirestoreCollection&lt;Stakeholder&gt; {
    return this.deliveryDoc(deliveryId).collection(&#x27;stakeholders&#x27;);
  }

  ///////////////////
  // CRUD DELIVERY //
  ///////////////////

  public updateDeliveryStatus(index: number): Promise&lt;any&gt; {
    return this.currentDeliveryDoc.update({ status: deliveryStatuses[index] });
  }

  public updateCurrentMGDeadline(index: number): Promise&lt;any&gt; {
    return this.currentDeliveryDoc.update({ mgCurrentDeadline: index });
  }

  /** Initializes a new delivery in firebase
   *
   * @param opts if templateId is present, the materials sub-collection is populated with materials from this template
   */
  public async addDelivery(opts: AddDeliveryOptions) {
    const id &#x3D; this.db.createId();
    const organization &#x3D; this.organizationQuery.getValue().org;
    const movieId &#x3D; opts.movieId || this.movieQuery.getActiveId();
    const movieRef &#x3D; this.movieDoc(movieId).ref;

    const delivery &#x3D; createDelivery({
      id,
      movieId,
      validated: [],
      mustChargeMaterials: opts.mustChargeMaterials,
      mustBeSigned: opts.mustBeSigned
    });

    await this.db.firestore.runTransaction(async (tx: firebase.firestore.Transaction) &#x3D;&gt; {
      const movieSnap &#x3D; await tx.get(movieRef);
      const deliveryIds &#x3D; movieSnap.data().deliveryIds || [];

      // Create document and permissions
      await this.permissionsService.createDocAndPermissions(delivery, organization, tx);

      // If there is a templateId, and mustBeSigned is true, copy template materials to the delivery
      if (!!opts.templateId &amp;&amp; delivery.mustBeSigned) {
        const template &#x3D; this.templateQuery.getEntity(opts.templateId);
        await this.copyMaterialsInDelivery(delivery, template, tx);
      }

      // If there is a templateId, and mustBeSigned is false, copy template materials to the movie
      if (!!opts.templateId &amp;&amp; !delivery.mustBeSigned) {
        const template &#x3D; this.templateQuery.getEntity(opts.templateId);
        await this.copyMaterialsInMovie(delivery, template, tx);
      }

      // Create the stakeholder in the sub-collection
      await this.shService.addStakeholder(delivery.id, organization.id, true, tx);

      // Update the movie deliveryIds
      const nextDeliveryIds &#x3D; [...deliveryIds, delivery.id];
      tx.update(movieRef, { deliveryIds: nextDeliveryIds });
    });

    return id;
  }

  /** Add a new delivery by copying the movie&#x27;s materials */
  public async addDeliveryWithMovieMaterials(opts?: AddDeliveryOptions) {
    const id &#x3D; this.db.createId();
    const movieId &#x3D; this.movieQuery.getActiveId();
    const organization &#x3D; this.organizationQuery.getValue().org;
    const movieRef &#x3D; this.movieDoc(movieId).ref;

    const delivery &#x3D; createDelivery({
      id,
      movieId,
      validated: [],
      mustChargeMaterials: opts.mustChargeMaterials,
      mustBeSigned: opts.mustBeSigned
    });

    await this.db.firestore.runTransaction(async (tx: firebase.firestore.Transaction) &#x3D;&gt; {
      const movieSnap &#x3D; await tx.get(movieRef);
      const deliveryIds &#x3D; movieSnap.data().deliveryIds || [];

      // Create document and permissions
      await this.permissionsService.createDocAndPermissions(delivery, organization, tx);

      // If mustBeSigned is true, copy materials to the delivery
      if (delivery.mustBeSigned) {
        await this.copyMaterialsInDelivery(delivery, movieSnap.data() as Movie, tx);
      }

      // If mustBeSigned is false, add deliveryId in deliveryIds of each material
      if (!delivery.mustBeSigned) {
        await this.pushDeliveryId(delivery.id, movieSnap.data() as Movie, tx);
      }

      // Create the stakeholder in the sub-collection
      await this.shService.addStakeholder(delivery.id, organization.id, true, tx);

      // Update the movie deliveryIds
      const nextDeliveryIds &#x3D; [...deliveryIds, delivery.id];
      tx.update(movieRef, { deliveryIds: nextDeliveryIds });
    });

    return id;
  }

  /** Add a delivery using all the settings picked in the creation tunnel */
  public async addDeliveryFromWizard(wizard: DeliveryWizard, movieId: string, templateId: string) {
    const mustBeSigned &#x3D; wizard.options.includes(DeliveryOption.mustBeSigned);
    const mustChargeMaterials &#x3D; wizard.options.includes(DeliveryOption.mustChargeMaterials);

    const opts: AddDeliveryOptions &#x3D; {
      movieId,
      mustChargeMaterials,
      mustBeSigned
    };

    switch (wizard.kind) {
      case DeliveryWizardKind.useTemplate:
        opts.templateId &#x3D; templateId;
        return this.addDelivery(opts);
      case DeliveryWizardKind.specificDeliveryList:
        return this.addDelivery(opts);
      case DeliveryWizardKind.blankList:
        return this.addDelivery(opts);
      case DeliveryWizardKind.materialList:
        return this.addDeliveryWithMovieMaterials(opts);
    }
  }

  /** Update informations of delivery */
  public updateInformations(delivery: Partial&lt;Delivery&gt;) {
    const batch &#x3D; this.db.firestore.batch();
    const deliveryId &#x3D; this.query.getActiveId();
    const deliveryRef &#x3D; this.deliveryDoc(deliveryId).ref;

    this.updateMGDeadlines(delivery, deliveryRef, batch);
    this.updateDates(delivery, deliveryRef, batch);
    this.updateSteps(delivery.steps, deliveryRef, batch);

    return batch.commit();
  }

  /** Update minimum guaranteed informations of delivery */
  private updateMGDeadlines(
    delivery: Partial&lt;Delivery&gt;,
    deliveryRef: firebase.firestore.DocumentReference,
    batch: firebase.firestore.WriteBatch
  ) {
    return batch.update(deliveryRef, {
      mgAmount: delivery.mgAmount,
      mgCurrency: delivery.mgCurrency,
      mgDeadlines: delivery.mgDeadlines
    });
  }

  /** Update dates of delivery */
  private updateDates(
    delivery: Partial&lt;Delivery&gt;,
    deliveryRef: firebase.firestore.DocumentReference,
    batch: firebase.firestore.WriteBatch
  ) {
    return batch.update(deliveryRef, {
      dueDate: delivery.dueDate,
      acceptationPeriod: delivery.acceptationPeriod,
      reWorkingPeriod: delivery.reWorkingPeriod
    });
  }

  /** Update steps of delivery */
  private updateSteps(
    steps: Step[],
    deliveryRef: firebase.firestore.DocumentReference,
    batch: firebase.firestore.WriteBatch
  ) {
    const oldSteps &#x3D; this.query.getActive().steps;

    // Add an id for new steps
    const stepsWithId &#x3D; steps.map(step &#x3D;&gt; (step.id ? step : { ...step, id: this.db.createId() }));

    // Find steps that need to be removed
    const deletedSteps &#x3D; oldSteps.filter(
      oldStep &#x3D;&gt; !stepsWithId.some(newStep &#x3D;&gt; newStep.id &#x3D;&#x3D;&#x3D; oldStep.id)
    );

    // Remove stepId from the materials according to this array
    this.removeMaterialsStepId(deletedSteps, batch);

    return batch.update(deliveryRef, { steps: stepsWithId });
  }

  /** Remove stepId of materials of delivery for an array of steps */
  private removeMaterialsStepId(steps: Step[], batch: firebase.firestore.WriteBatch) {
    // TODO(issue#773): Use a transaction to make sure we don&#x27;t lose data
    const deliveryId &#x3D; this.query.getActiveId();

    // We also set the concerned materials stepId to an empty string
    steps.forEach(step &#x3D;&gt; {
      const materials &#x3D; this.materialQuery.getAll().filter(material &#x3D;&gt; material.stepId &#x3D;&#x3D;&#x3D; step.id);

      materials.forEach(material &#x3D;&gt; {
        const ref &#x3D; this.materialDeliveryDoc(deliveryId, material.id).ref;
        batch.update(ref, { stepId: &#x27;&#x27; });
      });
    });
  }

  /** Remove signatures in array validated of delivery */
  public unsealDelivery(): Promise&lt;void&gt; {
    // TODO(issue#775): ask all stakeholders for permission to re-open the delivery form
    return this.currentDeliveryDoc.update({ validated: [], isSigned: false });
  }

  /** Deletes delivery and all the sub-collections in firebase */
  public async deleteDelivery(): Promise&lt;any&gt; {
    return this.currentDeliveryDoc.delete();
  }

  /** Push stakeholder id into validated array as a signature */
  public signDelivery(deliveryId?: string): Promise&lt;any&gt; {
    let delivery: Delivery;

    if (!!deliveryId) {
      delivery &#x3D; this.query.getEntity(deliveryId);
    } else {
      delivery &#x3D; this.query.getActive();
    }

    const organizationId &#x3D; this.organizationQuery.getValue().org.id;
    const { id, validated, stakeholders } &#x3D; delivery;

    const stakeholderSignee &#x3D; stakeholders.find(
      ({ id: stakeholderId }) &#x3D;&gt; organizationId &#x3D;&#x3D;&#x3D; stakeholderId
    );

    if (!validated.includes(stakeholderSignee.id)) {
      const updatedValidated &#x3D; [...validated, stakeholderSignee.id];
      return this.deliveryDoc(id).update({ validated: updatedValidated });
    }
  }

  /** Sign the delivery and save this action into active organization logs */
  public setSignDeliveryTx(orgEthAddress: string, deliveryId: string, deliveryHash: string, movieId: string) {
    const name &#x3D; &#x60;Delivery #${deliveryId}&#x60;; // TODO better delivery name (see with @ioaNikas)
    const callback &#x3D; async () &#x3D;&gt; {
      await Promise.all([
        this.db
          .collection(&#x27;actions&#x27;)
          .doc(deliveryHash)
          .set({ name }),
        this.signDelivery(deliveryId)
      ]);
    };
    const feedback: TxFeedback &#x3D; {
      confirmation: &#x60;You are about to sign the delivery ${name}&#x60;,
      success: &#x60;The delivery has been successfully signed !&#x60;,
      redirectName: &#x27;Back to Delivery&#x27;,
      redirectRoute: &#x60;/layout/o/delivery/${movieId}/${deliveryId}/informations&#x60;,
    }
    this.walletService.setTx(CreateTx.approveDelivery(orgEthAddress, deliveryHash, callback));
    this.walletService.setTxFeedback(feedback);
  }

  /** Create a transaction to copy the template/movie materials into the delivery materials */
  public async copyMaterialsInDelivery(
    delivery: Delivery,
    document: BFDoc,
    tx: firebase.firestore.Transaction
  ) {
    const materials &#x3D; await this.db.snapshot&lt;Material[]&gt;(
      &#x60;${document._type}/${document.id}/materials&#x60;
    );

    materials.forEach(material &#x3D;&gt; {
      tx.set(this.materialDeliveryDoc(delivery.id, material.id).ref, {
        ...material,
        state: &#x27;&#x27;,
        deliveryIds: null,
        stepId: &#x27;&#x27;
      });
    });

    return tx;
  }

  /** Add a new deliveryId in each materials of a movie */
  public async pushDeliveryId(
    deliveryId: string,
    document: BFDoc,
    tx: firebase.firestore.Transaction
  ) {
    const materials &#x3D; await this.db.snapshot&lt;Material[]&gt;(
      &#x60;${document._type}/${document.id}/materials&#x60;
    );

    materials.forEach(material &#x3D;&gt; {
      const targetRef &#x3D; this.db.doc&lt;Material&gt;(&#x60;movies/${document.id}/materials/${material.id}&#x60;).ref;
      tx.update(targetRef, { deliveryIds: [...material.deliveryIds, deliveryId] });
    });

    return tx;
  }

  /** Copy the template materials into the movie materials */
  public async copyMaterialsInMovie(
    delivery: Delivery,
    document: BFDoc,
    tx: firebase.firestore.Transaction
  ) {
    // NOTE: There is no way to query a collection within the transaction
    // So we accept a race condition here
    const materials &#x3D; await this.db.snapshot&lt;Material[]&gt;(&#x60;${document._type}/${document.id}/materials&#x60;);
    const movieMaterials &#x3D; await this.db.snapshot&lt;Material[]&gt;(&#x60;movies/${delivery.movieId}/materials&#x60;);

    materials.forEach(material &#x3D;&gt; {
      const sameValuesMaterial &#x3D; movieMaterials.find(movieMaterial &#x3D;&gt; this.materialService.isTheSame(movieMaterial, material));
      const isNewMaterial &#x3D; !movieMaterials.find(movieMaterial &#x3D;&gt; movieMaterial.id &#x3D;&#x3D;&#x3D; material.id) &amp;&amp; !sameValuesMaterial;

      // We check if material is brand new. If so, we just add it to database and return.
      if (isNewMaterial) {
        this.materialService.setNewMaterial(material, delivery, tx);
        return;
      }

      // If there already is a material with same properties (but different id), we merge this
      // material with existing one, and push the new deliveryId into deliveryIds.
      if (!!sameValuesMaterial) {
        this.materialService.updateMaterialDeliveryIds(sameValuesMaterial, delivery, tx);
      }

      // If values are not the same, this material is considered as new and we have to create
      // and set a new material (with new Id).
      if (!sameValuesMaterial) {
        const newMaterial &#x3D; createMaterial({...material, id: this.db.createId()});
        this.materialService.setNewMaterial(newMaterial, delivery, tx);
      }
    });
    return tx;
  }

  ////////////////////////
  // CRUD STAKEHOLDERS //
  //////////////////////

  /** Add a stakeholder to the delivery */
  public addStakeholder(movieStakeholder: Stakeholder) {
    const delivery &#x3D; this.query.getActive();
    const deliveryStakeholder &#x3D; delivery.stakeholders.find(
      stakeholder &#x3D;&gt; stakeholder.id &#x3D;&#x3D;&#x3D; movieStakeholder.id
    );

    // If deliveryStakeholder doesn&#x27;t exist yet, we need to create him
    if (!deliveryStakeholder) {
      const newDeliveryStakeholder &#x3D; createStakeholder({ id: movieStakeholder.id, isAccepted: false });

      return this.deliveryStakeholderDoc(delivery.id, newDeliveryStakeholder.id).set(
        newDeliveryStakeholder
      );
    }
  }

  /** Delete stakeholder delivery */
  public removeStakeholder(stakeholderId: string) {
    const deliveryId &#x3D; this.query.getActiveId();
    return this.deliveryStakeholderDoc(deliveryId, stakeholderId).delete();
  }
}
</code></pre>
    </div>
</div>


                   




                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> result-matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'interface';
            var COMPODOC_CURRENT_PAGE_URL = 'AddDeliveryOptions.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>
       <!-- Required to polyfill modern browsers as code is ES5 for IE... -->
       <script src="../js/libs/custom-elements-es5-adapter.js" charset="utf-8" defer></script>
       <script src="../js/menu-wc.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
